<div class="dashboard-wrapper">
  <section *ngIf="isLoading" class="loading-state space-y-4">
    <div class="skeleton h-40"></div>
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="skeleton h-28" *ngFor="let _ of [0, 1, 2, 3]"></div>
    </div>
    <div class="grid gap-4 lg:grid-cols-3">
      <div class="skeleton h-64" *ngFor="let _ of [0, 1, 2]"></div>
    </div>
  </section>

  <section *ngIf="!isLoading && error" class="error-state">
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="retry()">Retry</button>
  </section>

  <ng-container *ngIf="!isLoading && !error && dashboard as data">
    <section class="hero-panel">
      <div class="hero-text">
        <p class="eyebrow">Welcome back,</p>
        <h1>{{ data.profile.username }}</h1>
        <p class="subtitle">
          Your personal control center for groups, polls, and chats - everything
          at a glance.
        </p>
        <div class="hero-pills">
          <span class="pill">{{ data.groups.length }} groups</span>
          <span class="pill">{{ data.privateChats.length }} private chats</span>
          <span class="pill">{{ data.polls.length }} active polls</span>
        </div>
      </div>
      <div class="stat-grid">
        <article
          class="stat-card"
          *ngFor="let stat of statHighlights; let i = index"
          [attr.data-accent]="stat.accent"
        >
          <p class="stat-label">{{ stat.label }}</p>
          <p class="stat-value">{{ stat.value }}</p>
          <p class="stat-helper">{{ stat.helper }}</p>
        </article>
      </div>
    </section>

    <div class="content-grid">
      <div class="primary-column space-y-6">
        <section class="glass-card">
          <header class="section-header">
            <div>
              <p class="eyebrow">Community</p>
              <h2>Your groups</h2>
            </div>
            <span class="badge">{{ data.groups.length }}</span>
          </header>

          <div *ngIf="!data.groups.length" class="empty-state">
            <p>You haven't joined any groups yet.</p>
          </div>

          <div class="group-grid" *ngIf="data.groups.length">
            <article
              class="group-card"
              *ngFor="let group of data.groups; trackBy: trackById"
            >
              <div class="group-heading">
                <h3>{{ group.name }}</h3>
                <span class="role-chip">{{ group.role }}</span>
              </div>
              <p class="group-description">{{ group.description }}</p>
              <div class="group-meta">
                <span>{{ group.memberCount }} members</span>
                <span>{{ group.pollCount }} polls</span>
                <span>{{ group.isPublic ? "Public" : "Private" }}</span>
              </div>
              <p class="group-date">
                since {{ group.createdAt | date: "MMM y" }}
              </p>
            </article>
          </div>
        </section>

        <section class="glass-card">
          <header class="section-header">
            <div>
              <p class="eyebrow">Direct messages</p>
              <h2>Private Chats</h2>
            </div>
            <span class="badge">{{ data.privateChats.length }}</span>
          </header>

          <div *ngIf="!data.privateChats.length" class="empty-state">
            <p>No private conversations yet.</p>
          </div>

          <ul class="chat-list" *ngIf="data.privateChats.length">
            <li
              class="chat-item"
              *ngFor="
                let chat of data.privateChats | slice: 0 : 6;
                trackBy: trackById
              "
            >
              <div class="avatar">
                {{ chat.participant.charAt(0).toUpperCase() }}
              </div>
              <div class="chat-content">
                <p class="chat-name">{{ chat.participant }}</p>
                <p class="chat-preview">
                  {{ chat.lastMessagePreview || "No messages yet" }}
                </p>
              </div>
              <span class="chat-time" *ngIf="chat.lastMessageAt">
                {{ chat.lastMessageAt | date: "shortTime" }}
              </span>
            </li>
          </ul>
        </section>
      </div>

      <div class="secondary-column space-y-6">
        <section class="glass-card">
          <header class="section-header">
            <div>
              <p class="eyebrow">Decisions</p>
              <h2>Current polls</h2>
            </div>
            <span class="badge">{{ data.polls.length }}</span>
          </header>

          <div *ngIf="!data.polls.length" class="empty-state">
            <p>No active polls right now.</p>
          </div>

          <ul class="poll-list" *ngIf="data.polls.length">
            <li
              class="poll-item"
              *ngFor="let poll of data.polls | slice: 0 : 5; trackBy: trackById"
            >
              <div>
                <p class="poll-question">{{ poll.question }}</p>
                <div class="poll-tags">
                  <span class="pill subtle">{{ poll.groupName }}</span>
                  <span class="pill subtle" *ngIf="poll.deadline">
                    Deadline: {{ poll.deadline | date: "MMM d, y" }}
                  </span>
                  <span class="pill subtle"
                    >{{ poll.optionCount }} options</span
                  >
                  <span class="pill subtle">{{ poll.totalVotes }} votes</span>
                </div>
              </div>
              <span
                class="status-dot"
                [class.status-open]="isDeadlineActive(poll.deadline)"
                [class.status-closed]="!isDeadlineActive(poll.deadline)"
              ></span>
            </li>
          </ul>
        </section>
        <section class="glass-card">
          <header class="section-header">
            <div>
              <p class="eyebrow">Activity</p>
              <h2>Latest messages</h2>
            </div>
            <span class="badge">{{ data.recentMessages.length }}</span>
          </header>

          <div *ngIf="!data.recentMessages.length" class="empty-state">
            <p>No activity.</p>
            <span>Start a conversation or share a file.</span>
          </div>

          <ul class="timeline" *ngIf="data.recentMessages.length">
            <li
              class="timeline-entry"
              *ngFor="let message of data.recentMessages; trackBy: trackById"
            >
              <div class="dot"></div>
              <div>
                <p class="timeline-time">
                  {{ message.timestamp | date: "short" }}
                </p>
                <p class="timeline-text">
                  {{ message.content || "Encrypted message" }}
                </p>
                <p class="timeline-meta">
                  <ng-container *ngIf="message.groupId"
                    >Group #{{ message.groupId }}</ng-container
                  >
                  <ng-container
                    *ngIf="!message.groupId && message.privateChatId"
                  >
                    Private chat #{{ message.privateChatId }}
                  </ng-container>
                </p>
              </div>
            </li>
          </ul>
        </section>
      </div>

      <section class="glass-card password-card full-width-card">
        <header class="section-header">
          <div>
            <p class="eyebrow">Security</p>
            <h2>Update password</h2>
          </div>
        </header>

        <form
          class="password-form"
          [formGroup]="passwordForm"
          (ngSubmit)="submitPasswordChange()"
          novalidate
        >
          <p class="helper-text">
            Choose a strong password to protect your cloud. Use a mix of
            letters, numbers, and special characters.
          </p>

          <div class="form-field">
            <label for="currentPassword">Current password</label>
            <input
              id="currentPassword"
              type="password"
              formControlName="currentPassword"
              autocomplete="current-password"
              [class.invalid]="
                pf['currentPassword'].invalid &&
                (pf['currentPassword'].dirty || pf['currentPassword'].touched)
              "
            />
            <p
              class="field-error"
              *ngIf="
                pf['currentPassword'].hasError('required') &&
                (pf['currentPassword'].dirty || pf['currentPassword'].touched)
              "
            >
              Please enter your current password.
            </p>
          </div>

          <div class="form-field">
            <label for="newPassword">New password</label>
            <input
              id="newPassword"
              type="password"
              formControlName="newPassword"
              autocomplete="new-password"
              [class.invalid]="
                pf['newPassword'].invalid &&
                (pf['newPassword'].dirty || pf['newPassword'].touched)
              "
            />
            <p class="hint">
              At least 8 characters including an uppercase letter, a number, and
              a special character.
            </p>
            <p
              class="field-error"
              *ngIf="
                pf['newPassword'].hasError('required') &&
                (pf['newPassword'].dirty || pf['newPassword'].touched)
              "
            >
              Please choose a new password.
            </p>
            <p
              class="field-error"
              *ngIf="
                pf['newPassword'].hasError('minlength') &&
                (pf['newPassword'].dirty || pf['newPassword'].touched)
              "
            >
              At least 8 characters required.
            </p>
            <p
              class="field-error"
              *ngIf="
                pf['newPassword'].hasError('pattern') &&
                (pf['newPassword'].dirty || pf['newPassword'].touched)
              "
            >
              Please meet the security requirements.
            </p>
          </div>

          <div class="form-field">
            <label for="confirmPassword">Confirm password</label>
            <input
              id="confirmPassword"
              type="password"
              formControlName="confirmPassword"
              autocomplete="new-password"
              [class.invalid]="
                (pf['confirmPassword'].invalid ||
                  passwordForm.hasError('mismatch')) &&
                (pf['confirmPassword'].dirty || pf['confirmPassword'].touched)
              "
            />
            <p
              class="field-error"
              *ngIf="
                pf['confirmPassword'].hasError('required') &&
                (pf['confirmPassword'].dirty || pf['confirmPassword'].touched)
              "
            >
              Please confirm your new password.
            </p>
            <p
              class="field-error"
              *ngIf="
                passwordForm.hasError('mismatch') &&
                (pf['confirmPassword'].dirty || pf['confirmPassword'].touched)
              "
            >
              Passwords do not match.
            </p>
          </div>

          <div class="form-feedback" *ngIf="passwordError || passwordSuccess">
            <p class="form-error" *ngIf="passwordError">{{ passwordError }}</p>
            <p class="form-success" *ngIf="passwordSuccess">
              {{ passwordSuccess }}
            </p>
          </div>

          <button
            class="primary-btn"
            type="submit"
            [disabled]="isSavingPassword || passwordForm.invalid"
          >
            <span *ngIf="!isSavingPassword">Update password</span>
            <span *ngIf="isSavingPassword">Updating&nbsp;...</span>
          </button>
        </form>
      </section>
    </div>
  </ng-container>
</div>
