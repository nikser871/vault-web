<div class="max-w-xl mx-auto bg-white rounded-md shadow-sm mt-4">
  <div class="flex items-center justify-between px-4 py-3 border-b">
    <h2 class="text-lg font-semibold text-gray-800">
      {{ isEditMode ? "Select Chats" : "Chats" }}
    </h2>
    <button
      (click)="toggleEditMode()"
      [class.bg-blue-500]="isEditMode"
      [class.text-white]="isEditMode"
      [class.bg-gray-200]="!isEditMode"
      [class.text-gray-700]="!isEditMode"
      class="px-4 py-2 rounded-md text-sm font-medium transition-colors hover:opacity-90"
    >
      {{ isEditMode ? "Done" : "Edit" }}
    </button>
  </div>

  <!-- Action Bar (shown on edit mode for selected items) -->
  <div
    *ngIf="isEditMode && hasSelectedChats"
    class="flex gap-2 border-b bg-gray-50 px-4 py-3"
  >
    <button
      (click)="openClearConfirmDialog()"
      class="flex-1 px-4 py-2 bg-red-500 text-white rounded-md text-sm font-medium hover:bg-red-600 transition-colors"
    >
      Clear Selected ({{ selectedChatIds.size }})
    </button>
    <button
      (click)="openCreateGroupDialog()"
      class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-md text-sm font-medium hover:bg-blue-600 transition-colors"
    >
      Create Group ({{ selectedChatIds.size }})
    </button>
  </div>

  <div *ngIf="isLoading" class="text-center text-gray-400 py-4">
    Loading ...
  </div>
  <div *ngIf="error" class="text-center text-red-500 py-4 font-medium">
    {{ error }}
  </div>

  <div *ngIf="!isLoading && !error">
    <div *ngIf="privateChats.length > 0">
      <div
        class="px-4 py-2 bg-gray-100 text-xs font-semibold text-gray-600 uppercase"
      >
        Private Chats
      </div>
      <ul class="divide-y divide-gray-200">
        <li
          *ngFor="let chat of privateChats"
          (click)="
            isEditMode ? toggleChatSelection(chat.id) : openPrivateChat(chat)
          "
          [class.bg-blue-50]="isChatSelected(chat.id)"
          [class.cursor-pointer]="true"
          [ngClass]="{ 'hover:bg-gray-100': !isChatSelected(chat.id) }"
          class="flex items-center px-4 py-3 transition"
        >
          <div *ngIf="isEditMode" class="mr-3">
            <input
              type="checkbox"
              [checked]="isChatSelected(chat.id)"
              (click)="$event.stopPropagation()"
              (change)="toggleChatSelection(chat.id)"
              class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
            />
          </div>
          <!-- Avatar -->
          <div
            class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center font-semibold mr-4 select-none flex-shrink-0"
          >
            {{ getOtherUsername(chat).charAt(0).toUpperCase() }}
          </div>

          <!-- Chat Info -->
          <div class="flex-1">
            <span class="text-gray-800 font-medium">{{
              getOtherUsername(chat)
            }}</span>
          </div>
        </li>
      </ul>
    </div>

    <div *ngIf="users.length > 0">
      <div
        class="text-xs font-semibold text-gray-600 bg-gray-100 px-4 py-2 uppercase"
      >
        All Users
      </div>

      <ul *ngIf="!isLoading && !error" class="divide-y divide-gray-200">
        <li
          *ngFor="let user of users"
          (click)="openChat(user.username)"
          class="flex items-center px-4 py-3 cursor-pointer hover:bg-gray-100 transition"
        >
          <div
            class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-semibold mr-4 select-none"
          >
            {{ user.username.charAt(0).toUpperCase() }}
          </div>
          <span class="text-gray-800 font-medium">{{ user.username }}</span>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Clear Confirmation Dialog -->
<div
  *ngIf="showClearConfirmDialog"
  class="fixed inset-0 flex items-center justify-center z-50"
  (click)="cancelDialog()"
>
  <div
    class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
    (click)="$event.stopPropagation()"
  >
    <h3 class="mb-2 text-lg font-semibold text-gray-900">Clear Chats?</h3>
    <p class="text-gray-600 mb-2">
      This will permanently delete all messages in
      {{ selectedChatIds.size }} selected chat(s).
    </p>
    <p class="text-red-600 font-medium mb-4">This action cannot be undone.</p>
    <div class="flex gap-3 justify-end">
      <button
        (click)="cancelDialog()"
        [disabled]="isProcessing"
        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors disabled:opacity-50"
      >
        Cancel
      </button>
      <button
        (click)="confirmClearChats()"
        [disabled]="isProcessing"
        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors disabled:opacity-50"
      >
        {{ isProcessing ? "Clearing..." : "Clear" }}
      </button>
    </div>
  </div>
</div>

<!-- Create Group Dialog -->
<div>
  <div
    *ngIf="showGroupDialog"
    class="fixed inset-0 flex items-center justify-center z-50"
    (click)="cancelDialog()"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Create Group</h3>
      <p class="text-gray-600 mb-4">
        Creating a group from {{ selectedChatIds.size }} chat(s)
      </p>

      <div>
        <label for="groupName" class="block text-sm font-medium text-gray-700">
          Group Name
        </label>
        <input
          id="groupName"
          [(ngModel)]="newGroupName"
          type="text"
          [disabled]="isProcessing"
          placeholder="Enter group name"
          class="px-3 py-3 w-full border border-gray-300 rounded-md focus:outline-none"
        />
      </div>

      <div>
        <label
          for="groupDescription"
          class="block text-sm font-medium text-gray-700"
        >
          Group Description
        </label>
        <input
          id="groupDescription"
          [(ngModel)]="groupDescription"
          type="text"
          [disabled]="isProcessing"
          placeholder="Enter group description"
          class="px-3 py-3 w-full border border-gray-300 rounded-md focus:outline-none"
        />
      </div>

      <div class="flex gap-3 py-2 justify-end">
        <button
          (click)="cancelDialog()"
          [disabled]="isProcessing"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
        <button
          (click)="confirmCreateGroup()"
          [disabled]="!newGroupName.trim() || isProcessing"
          class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors disabled:opacity-50"
        >
          {{ isProcessing ? "Creating..." : "Create" }}
        </button>
      </div>
    </div>
  </div>
</div>

<app-private-chat-dialog
  *ngIf="selectedUsername && privateChatId"
  [username]="selectedUsername"
  [currentUsername]="currentUsername"
  [privateChatId]="privateChatId"
  (closeChat)="closeChat()"
/>
